<template>
    <div class="mark_as_completed_form">
        <div 
        style="
        display:flex;
        flex-direction:row;">
        
            <h2 class="h2s">
                Mark as completed
            </h2>

             <b-button  
             class="btn btn-danger btn-secondary" 
             id="close_btn_mark_completed" 
             @click="closeModalMarkJobAsCompleted()">
                <icon
                name ="window-close">
                </icon>  
            </b-button>


        </div>
       <div class="group_input_title">

            <h3 class="h3s">
                Insert description.
            </h3>
            
            <textarea  class="textarea_everyone"
            :placeholder="descinput.label"
            :class="{'has-error':errDesc}"
            :type="descinput.type"
            :id="descinput.id" 
            v-model="descinput.value" 
            required:true
                v-validate="{
                rules:{
                    required:true
                }}"
            :name="descinput.id">
            
            </textarea>


            <span v-if="errors.has(descinput.id)" class="incorrect_input">
                {{descinput.id_upper}} required!
            </span>
        
        </div>

        
        <div class="group_input_title">
            <h3 class="h3s">
                Insert document.
            </h3>

            <b-form-file 
            accept=".zip"
            @change="processFile($event)"
            name="file"
            placeholder="Choose file">

            </b-form-file>
        </div>

        <b-button
        class="btn btn-success submit-btn-mark-completed"
        @click = "markJobAsCompleted()"
        style="
        margin-left: auto;
        border-radius:0;"
        
        > 
        Submit
        </b-button>

    </div>
</template>

<script>
import Icon from "vue-awesome/components/Icon";
import ConvoSendMessagesAPI from "../../../../services/api/pentester_api/ConvoSendMessages.api";
import "vue-awesome/icons/window-close";

import eventBus from '../../../../utils/eventBus';


export default {
    mounted() {

    },
    computed : {
        errDesc() {
            return this.errors.has(this.descinput.id);
        }
    },
    components: {
        Icon
    },
    props: {
        markCompleted : {
            type: Boolean,
        }
    },
    methods: {
        processFile(event)
        {
            this.formData.append("document", event.target.files[0]);
        },

        closeModalMarkJobAsCompleted() {
            eventBus.$emit("isVisibleModalMarkJobAsCompleted", false);
        },
        markJobAsCompleted() {
            
            this.$validator.validateAll().then((form_ok) => {
                if(form_ok)
                {
                    this.formData.append("description",this.descinput.value);
                    let job_id = this.$store.getters.returnParams.job_id;
                    ConvoSendMessagesAPI.completeJob(job_id, this.formData)
                    .then(()=> {
                        this.notifySuccess("Marked as completed", "Success!");
                        eventBus.$emit("isVisibleModalMarkJobAsCompleted", false);
                    });                    
                }
            
            })
            
        }
    
    },
    data() {
        return {
            formData : new FormData(),

            descinput: 
            {
                id: "desc",
                label: "description",
                type: "text",
                value: "",
                id_upper: "Description"
            },
        }
    }
}
</script>

<style lang="scss" scoped>
.submit-btn-mark-completed {
    margin: 2%;
}

#close_btn_mark_completed {
    margin-left: auto;
}
#close_btn_mark_completed /deep/ svg {
    vertical-align: middle;
}

.has-error {
  border: 1px solid rgba(255, 0, 0, 1);
}

</style>
