<template>
    <div class="comp_container">
        <h2 class="h2s">Convo with {{findSender()}}</h2>

        <div 
        class = "msg_cont "
        v-for="msg in whole_convo"
        :key = msg.msg_id
        >
        
            <div 
            class="client d-flex"
            v-if = "msg.client_to_pentester"
            >
                <div class="col-2">
                    <img 
                    src="http://i.pravatar.cc/100?img=3" 
                    class="client_avatar"
                    alt="">
                   
                </div>

                <div class="col-8">
                    <div class = "msg_cont_header_client">
                        <p><strong>{{msg.date_time}}</strong></p>           
                    </div>

                    <p>
                    {{msg.message}}
                    </p>
                </div>

            </div>

            <div
            class="pentester d-flex"
            v-if="msg.pentester_to_client"
            >
                <div class="col-2">

                    <img 
                    src="http://i.pravatar.cc/100?img=4" 
                    class="pentester_avatar"
                    alt=""> 

                </div>
                <div class="col-8">

                    <div class = "msg_cont_header_pent">
                        <p><strong>{{msg.date_time}}</strong></p>           
                    </div>
                    
                    <p>
                        {{msg.message}}
                    </p>
                </div>

            </div>


        </div>

        <!-- RENDER NEW MESSAGES -->
        
        <div v-if="msgs_for_send.length"
            class="pentester msg_cont d-flex">

                <div class="col-2">
                    <img 
                    src="http://i.pravatar.cc/100?img=4" 
                    class="client_avatar"
                    alt="">
                </div>

                <div class="col-8">
                    <div class = "msg_cont_header_client">
                        <p><strong>{{msgs_for_send[0].date_time}}</strong></p>           
                    </div>
                    
                    <p>
                        {{bundleMessages()}}
                    </p>
                </div>
        </div>



        <div class="cont_input_msg">
        
            <input 
            name="msg_client" 
            class="msg_input"
            @keyup.enter="bufferMsgForSending()"
            v-model="one_msg"/>
            
            <b-button 
            @click="bufferMsgForSending()" 
            class="btn btn-info btn_send"
            style="border-radius: 0;">
                <icon name= "paper-plane"> </icon>
            </b-button>
        
        </div>
    </div>

</template>

<script>
import ConvoHardcode from "../convo.hardcode";
import PentConvoAPI from "../../../../services/api/pentester_api/Convo.api";
import ConvoSendMessagesAPI from "../../../../services/api/pentester_api/ConvoSendMessages.api";

import Icon from "vue-awesome/components/Icon";
import "vue-awesome/icons/paper-plane";

export default {
  destroyed() {
    //TODO: salje se niz poruka
    //TODO : msgs_for_send
    //TODO: moguce vise poruka da iskuca odma
    //TODO: se vide salje se kad izlazi sa komponente
  },
  created() {
    //TODO: ovde da se puni komponenta
    //TODO : na osnovu job_id i pentester_id da se povuce convo
    //TODO: job_id se cuva u vuex..
    //ConvoHardcode.getConv(job_id,user_id)..
  },
  mounted() {
    this.job_id = this.$store.getters.returnParams;

    this.user_name = this.$store.getters.returnUser;
    this.user_name = this.user_name.name;
  },
  components: {
    Icon
  },

  methods: {
    bundleMessages() {
      let msgs_only = this.msgs_for_send.map(msg => msg.message);

      return msgs_only.join(" ");
    },
    bufferMsgForSending() {
      if (!this.one_msg.length) return;

      let new_msg = {
        msg_id: this.msgs_for_send.length - 1,
        client_to_pentester: false,
        pentester_to_client: true,
        date_time: moment().format("DD.MM.YYYY hh:mm"),
        sender: this.user_name,
        message: this.one_msg
      };
      this.one_msg = "";

      this.msgs_for_send.push(new_msg);

      ConvoSendMessagesAPI.sendMsg(new_msg);
    },
    //find client that sent msg
    findSender() {
      let sender = this.whole_convo.find(elem => {
        if (elem.client_to_pentester) return elem;
      });
      return sender.sender;
    }
  },
  data() {
    return {
      one_msg: "",
      msgs_for_send: [],
      whole_convo: ConvoHardcode
    };
  }
};
</script>

<style scoped>
.client_avatar {
  border-radius: 50%;
  float: left;
  margin: 2%;
}
.pentester_avatar {
  border-radius: 50%;
  float: right;
  margin: 2%;
}

.btn_send {
  flex: 0.2;
}

.msg_input {
  flex: 2;
}
.cont_input_msg {
  display: flex;
  flex-direction: row;
}

.msg_cont_header_client {
  text-align: left;
  border-bottom: 1px solid #233dbb;
}

.msg_cont_header_pent {
  text-align: right;
  border-bottom: 1px solid rgba(170, 4, 60, 0.878);
}

.msg_cont_header {
  display: flex;
  flex-direction: row;
}

.msg_cont {
  width: 100%;
}

.client {
  text-align: left;
  width: 100%;
  height: fit-content;
  padding: 3%;
  margin: 5% 0 5% 0;
}
.pentester {
  text-align: right;
  flex-direction: row-reverse;
  width: 100%;
  height: fit-content;
  padding: 3%;
  margin: 5% 0 5% 0;
}
</style>
