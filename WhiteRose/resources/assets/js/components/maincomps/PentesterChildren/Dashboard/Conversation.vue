<template>
    <div class="comp_container">
          <transition 
          name="mark-completed">
          
            <mark-as-completed-form 
            :markCompleted = "isMarkAsCompleted"
            v-if="isMarkAsCompleted 
            && whole_convo.completed !== 1">

            </mark-as-completed-form>
          
          </transition>

            <div 
            style="
            display:flex;
            flex-direction:row;">

              <h2 class="h2s">Convo with {{whole_convo.client}}</h2>
              
              <b-button
              class="btn btn-success"
              @click = "openModalMarkJobAsCompleted()"
              style="
              margin-left: auto;
              border-radius:0;"
              v-if="whole_convo.completed !== 1"
              > 
              Mark as completed
              </b-button>

            </div>
            <span 
            class="del_msg"
            v-b-tooltip.hover.right="'Delete messages'"
            style="cursor:pointer;"
            @click="deleteConvo()">
            <icon
              name="trash-alt">
            </icon>
            </span>

    
<!--          
          <star-rating 
    
          style="
            float: left;
            width: fit-content;"
    
          v-model="rating"
          :show-rating = "false"
          :increment="0.5"
          :star-size="20"
          >
          </star-rating> -->
     
        
           


        <!-- <div 
        class = "msg_cont "
        v-for="(disc) in whole_convo.discusion"
        :key = disc.id
        > -->
          <div
          class = "msg_cont "
          v-for="(msg) in whole_convo.discusion.messages"
          :key = msg.id
          >
        
            <div 
            class="client d-flex"
            v-if="msg.clientToPentester==1"
            >
                <div class="col-2 convo_avatars">
                    <img 
                    :src="not_my_avatar" 
                    class="client_avatar"
                    alt="">
                   
                </div>

                <div class="col-8">
                    <div class = "msg_cont_header_client flex_header">
                        <p
                        class="msg_container_time"
                        v-b-tooltip.hover.top="toolTipDate(msg.updated_at)"
                        >

                          <strong>
                            {{timeOfMessage(msg.updated_at)}}
                          </strong>
                          
                        </p>                   
                    </div>

                    <p
                    v-for="(message,index) in renderMessages(msg.text,msg.first)"
                    :key = index
                    >
                      <span style="color:#0ca200bd;" v-if="msg.first">
                        {{message}}  
                      </span>
                      
                      <span  style="color:red;" v-else-if="msg.last"> 
                      
                        {{message}}
                      
                      </span>

                      <span
                      v-else
                      >
                      
                        {{message}}
                      
                      </span>
                    </p>
                </div>

            </div>

            <div
            class="pentester d-flex"
            v-else 
            >
                <div class="col-2 convo_avatars">

                    <img 
                    :src="my_avatar"  
                    class="pentester_avatar"
                    alt=""> 

                </div>
                <div class="col-8">

                    <div class = "msg_cont_header_pent flex_header">
                        <p
                        class="msg_container_time"
                        v-b-tooltip.hover.top="toolTipDate(msg.updated_at)"
                        >

                          <strong>
                            {{timeOfMessage(msg.updated_at)}}
                          </strong>
                          
                        </p>                  
                    </div>
                    
                    <p
                    v-for="(message,index) in renderMessages(msg.text,
                    msg.first)"
                    :key = index
                    >
                    {{message}}
                    </p>
                </div>

            </div>

          </div>
        <!-- </div> -->

        <!-- RENDER NEW MESSAGES -->
        
        <div v-if="msgs_for_send.length"
            class="pentester msg_cont d-flex">

                <div class="col-2 convo_avatars">
                    <img 
                    :src="my_avatar" 
                    class="client_avatar"
                    alt="">
                </div>

                <div class="col-8">
                    <div class = "msg_cont_header_pent">
                        <p
                        class="msg_container_time flex_header"
                        v-b-tooltip.hover.top="toolTipDate(client_msg_time)"
                        >

                          <strong>
                            {{timeOfMessage(client_msg_time)}}
                          </strong>
                          
                        </p>                
                    </div>

                    <div class="bubble left-in">

                      <!-- <p class="msg_bubble">
                          {{bundleMessages()}}
                      </p> -->

                    <p
                      v-for="msg4 in msgs_for_send"
                      :key = msg4.id                  
                      >
                      {{msg4.message}}
                    </p>

                    </div>
                    
                </div>
        </div>



        <div 
        v-if="whole_convo.completed !== 1"
        class="cont_input_msg">
        
            <input 
            name="msg_client" 
            class="msg_input"
            @keyup.enter="bufferMsgForSending()"
            v-model="one_msg"/>
            
            <b-button 
            @click="bufferMsgForSending()" 
            class="btn btn-info btn_send"
            style="border-radius: 0;">
                <icon name= "paper-plane"> </icon>
            </b-button>
        
        </div>


        
        <!-- IF COMPLETED JOB -->
        <div 
          class="cont_input_msg"
          v-if="whole_convo.completed == 1"
        >
          <h2 class="h2s">
            This job ended.
          </h2>
        
        </div>
    </div>

</template>

<script>
/**Vuex */
import { mapGetters } from "vuex";

/**API */
import PentConvoAPI from "../../../../services/api/pentester_api/Convo.api";
import ConvoSendMessagesAPI from "../../../../services/api/pentester_api/ConvoSendMessages.api";
import DeleteConvoAPI from "../../../../services/api/pentester_api/DeleteConvo.api";

/**COMPONENTS */
import MarkAsCompletedForm from "./MarkAsCompletedForm.vue";
import StarRating from "vue-star-rating";
import Icon from "vue-awesome/components/Icon";

/**Event bus */
import eventBus from "../../../../utils/eventBus";

/**ICONS */
import "vue-awesome/icons/paper-plane";
import "vue-awesome/icons/trash-alt";

export default {
  destroyed() {
    //TODO: salje se niz poruka
    //TODO : msgs_for_send
    //TODO: moguce vise poruka da iskuca odma
    //TODO: se vide salje se kad izlazi sa komponente
    //TODO: posalji rating..
    // console.log(this.rating);
  },
  created() {
    //TODO: ovde da se puni komponenta
    //TODO : na osnovu job_id i pentester_id da se povuce convo
    //TODO: job_id se cuva u vuex..
    //ConvoHardcode.getConv(job_id,user_id)..

    this.job_id = this.$store.getters.returnParams;
    PentConvoAPI.getConversation(this.job_id).then(
      resp => {
        this.whole_convo = resp
        console.log(this.whole_convo);
      }
    );
 
  },
  mounted() {
    // this.job_id = this.$store.getters.returnParams;

    this.user_name = this.$store.getters.returnUser;

    this.user_name = this.user_name.name;

    this.msg_send_id = 0;

    eventBus.$on("isVisibleModalMarkJobAsCompleted", val => {
      this.isMarkAsCompleted = val;
      console.log(this.isMarkAsCompleted);
    });
  },
  computed: {
    ...mapGetters({
      my_avatar: "returnAvatar",
      not_my_avatar: "returnAvatarPath"
    })
  },
  components: {
    Icon,
    MarkAsCompletedForm,
    StarRating
  },

  methods: {
    timeOfMessage(time) {
      return moment(time).format("hh:mm");
    },
    toolTipDate(date) {
      return moment(date).format("dddd DD-MM");
    },
    deleteConvo() {
      alert("clicked");
      DeleteConvoAPI.deleteConvo(this.job_id);
    },
    bundleMessages() {
      let msgs_only = this.msgs_for_send.map(msg => msg.message);

      return msgs_only.join(" ");
    },
    bufferMsgForSending() {
      if (!this.one_msg.length) return;

      let new_msg = {
        // msg_id: this.msgs_for_send.length - 1,
        id: this.msg_send_id,
        client_to_pentester: false,
        pentester_to_client: true,
        date_time: moment().format("YYYY-MM-DD hh:mm:ss"),
        sender: this.user_name,
        message: this.one_msg,
        discusionID: this.whole_convo.discusion.id
      };

      this.client_msg_time = new_msg.date_time;

      this.one_msg = "";
      this.msg_send_id++;

      this.msgs_for_send.push(new_msg);

      ConvoSendMessagesAPI.sendMsg(new_msg);
    },
    //find client that sent msg
    findSender() {
      let sender = this.whole_convo.find(elem => {
        if (elem.client_to_pentester) return elem;
      });
      return sender.sender;
    },
    renderMessages(msg,first) {
      let array = JSON.parse("[" + msg + "]");
      let message_text = array[0];
      // message_text = message_text[0];

      if (first) {
        message_text = message_text[0];

        const ind = message_text.indexOf("job");
        let first_message = message_text.slice(0, ind + 3);
        console.log("poruka", first_message);
        return [first_message];
      }

      return message_text;
    },
    openModalMarkJobAsCompleted() {
      this.isMarkAsCompleted = true;
    },

    markJobAsCompleted() {
      ConvoSendMessagesAPI.completeJob(this.whole_convo.discusion[0].job_id);
    }
  },
  data() {
    return {
      //Visibility vars
      isMarkAsCompleted: false,

      one_msg: "",
      rating: undefined,
      msgs_for_send: [],
      whole_convo: {
        discusion: {}
      },
      msg_send_id: undefined
    };
  }
};
</script>

<style lang="scss" scoped>
$borderica-pentesterica: rgba(170, 4, 60, 0.878);
$borderica-clientica: #233dbb;
.flex_header {
  display: flex;
  flex-direction: column;
}

.del_msg > svg {
  vertical-align: middle;
  margin-left: 2%;
}
.del_msg:hover {
  color: red;
}
.client_avatar {
  border-radius: 50%;
  float: left;
  margin: 2%;
}
.pentester_avatar {
  border-radius: 50%;
  float: right;
  margin: 2%;
}

.btn_send {
  flex: 0.2;
}

.msg_input {
  flex: 2;
}
.cont_input_msg {
  display: flex;
  flex-direction: row;
}

.msg_cont_header_client {
  border-bottom: 1px solid $borderica-clientica;
  margin-right: auto;
  cursor: pointer;
  width: fit-content;
}

.msg_cont_header_pent {
  border-bottom: 1px solid $borderica-pentesterica;
  margin-left: auto;
  width: fit-content;
  height: fit-content;
  margin-bottom: 0;
  cursor: pointer;
}

.msg_cont_header {
  display: flex;
  flex-direction: row;
}

.msg_cont {
  width: 100%;
}

.client {
  text-align: left;
  width: 100%;
  height: fit-content;
  padding: 3%;
  margin: 5% 0 5% 0;
}

.pentester {
  text-align: right;
  flex-direction: row-reverse;
  width: 100%;
  height: fit-content;
  padding: 3%;
  margin: 5% 0 5% 0;
}

.msg_container_time
{
  margin-bottom: 0;
}


</style>
