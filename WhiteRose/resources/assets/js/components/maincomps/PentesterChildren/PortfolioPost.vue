<template>
  <div id="job_poster" class="comp_container">
    <h2 class="h2s">Post your Project here.</h2>
  
    <div class="group_input_title">
      <h3 class="h3s">
        Insert title.
      </h3>

      <portf-input
      :prop.sync="titleinput" 
      >
      </portf-input>
    </div>

    <div class="group_input_title">
        
        <h3 class="h3s">
            Insert date range.
        </h3>
        <div class="align_dps">
            <span><strong>From : </strong></span>
            
            <input
            name="date_from"
            required:true
            :class="{'has-error':errDateFrom}"
            />

            <span><strong>To: </strong></span>
            
            <input  
            name="date_to"
            required:true
            :class="{'has-error':errDateTo}"
            :min="date_from"/>
        </div>    
    </div>


    <div class="group_input_title">

      <h3 class="h3s">
        Insert description.
      </h3>
      
      <textarea  
      :placeholder="desc.label"
      :class="{'has-error':errDesc}"
      :type="desc.type"
      :id="desc.id" 
      v-model="desc.value" 
      required:true
        v-validate="{
        rules:{
            required:true
        }}"
      :name="desc.id">
      </textarea>


      <span v-if="errors.has(desc.id)" class="incorrect_input">
          {{desc.id_upper}} required!
      </span>
    
    </div>




    <div class="group_input_title">
      <h3 class="h3s">
        Insert image to fullfill your project.
      </h3>

      <b-form-file 
      @change="processFile($event)"
      name="image"
      accept="image/jpg, image/png, image/gif" 
      :state="!errImage"
      v-model="some_image" 
      required:true
    v-validate="{
    rules:{
        required:true
    }}"
      placeholder="Choose file">

      </b-form-file>

      
      <span v-if="errors.has('image')" 
      class="incorrect_input">
          Image required!
      </span>

    </div>

    

    <b-button 
    class="btn btn-info btn-secondary actionbtn" 
    @click="submitHandler()">
      Post  <icon name="file-alt" id="hands_icon"></icon>
    </b-button>

  </div>


</template>

<script>
import eventBus from "../../../utils/eventBus";
import PortfInput from "../../utilcomps/PortfPosterInput.vue";
import Icon from "vue-awesome/components/Icon";
import "vue-awesome/icons/file-alt";

import PortfolioPostAPI from "../../../services/api/pentester_api/PortfolioPost.api";
import daterangepicker from "daterangepicker";

//TODO : Submit is not a function ..
export default {
  destroyed() {
    let dp = $(".daterangepicker");
    let arr_of_dps = [...dp];

    arr_of_dps.forEach(l => {
      l.remove();
    });
  },
  created() {},
  computed: {
    errDateFrom() {
      return this.errors.has("date_from");
    },
    errDateTo() {
      return this.errors.has("date_to");
    },
    errDesc() {
      return this.errors.has(this.desc.id);
    },
    errImage() {
      return this.errors.has("image");
    }
  },
  components: {
    PortfInput,
    Icon
  },
  mixins: [],
  mounted() {
    //adds func to first input
    $('input[name="date_from"]').daterangepicker(
      {
        singleDatePicker: true,
        showDropdowns: true,
        locale: {
          format: "DD-MMM-YYYY",
          fromLabel: "From",
          toLabel: "To",
          customRangeLabel: "Custom",
          weekLabel: "W",
          daysOfWeek: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
          monthNames: [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
          ],
          firstDay: 1
        },
        linkedCalendars: false,
        showCustomRangeLabel: false,
        alwaysShowCalendars: true,
        opens: "center"
      },
      start => {
        this.date_from = moment(start).format("DD/MM/YYYY");
      }
    );

    //adds func to second input
    $('input[name="date_to"]').daterangepicker(
      {
        singleDatePicker: true,
        showDropdowns: true,
        autoApply: true,
        locale: {
          format: "DD-MMM-YYYY",
          fromLabel: "From",
          toLabel: "To",
          customRangeLabel: "Custom",
          weekLabel: "W",
          daysOfWeek: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
          monthNames: [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
          ],
          firstDay: 1
        },
        linkedCalendars: false,
        showCustomRangeLabel: false,
        alwaysShowCalendars: true,
        opens: "center"
      },
      start => {
        this.date_to = moment(start).format("DD/MM/YYYY");
      }
    );

    eventBus.$on("field_ok", val => {
      this.input_valid = true;
    });
  },

  methods: {
     processFile(event) {
      
      //fix for changing the file often
      this.sendData = new FormData();

      this.sendData.append("avatar", event.target.files[0]);
    },
    submitHandler() {
      eventBus.$emit("validateAllFields");


      PortfolioPostAPI.handlePortfolioPosting(this, this.$validator);
    }
  },
  data() {
    return {
      //FormDataWrapper
      sendData : new FormData(),

      //Data for posting
      input_valid: false,
      
      //for validation
      some_image : null,
      
      
      date_from: null,
      date_to: null,

      config: {
        format: "DD/MM/YYYY"
      },
      desc: {
        id: "desc",
        label: "project description here",
        type: "text",
        value: "",
        id_upper: "Description"
      },
      titleinput: {
        id: "title",
        label: "title",
        type: "text",
        value: ""
      }
    };
  }
};
</script>

<style scoped>
.align_dps {
  margin-top: 5%;
  display: flex;
  flex-direction: row;
}

.align_dps * {
  margin: auto;
}
@media (max-width: 900px) {
  .align_dps {
    flex-direction: column;
  }
}

.group_input_title {
  margin-bottom: 6%;
}
.group_input_title_first {
  margin-top: 3%;
}
textarea {
  box-shadow: 0px 0px 2px #949494;
  text-align: center;
  outline: none !important;
  border-bottom: 1px solid rgba(0, 8, 53, 0.603);
  background-color: transparent;
  border: 0px;
  width: 100%;
  min-height: 80px;
}

.has-error {
  border: 1px solid rgba(255, 0, 0, 1);
}
</style>
