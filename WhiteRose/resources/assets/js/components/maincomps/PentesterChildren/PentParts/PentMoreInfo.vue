<template>
  <div id="jobs_more_info" class="comp_container preview_from_table_container">
      
    <b-button  class="btn btn-danger btn-secondary" id="close_btn" @click="disableMoreInfo()">
      <icon
      name ="window-close">
      </icon>  
    </b-button>
     <transition name="flip" mode="out-in">
      <div v-if="!applied">

        <h2 class="h2s">Job by {{det.client}}</h2>

        <h3 class="h3s">Rating:</h3>
        <p>{{det.user_rating}}</p>

        <h3 class="h3s">Title:</h3>
        <p>{{det.title}}</p>

        <h3 class="h3s">Message:</h3>
        <p>{{det.description}}</p>

        <b-button  class="btn btn-success btn-secondary" 
          @click="applyForJob()">
            Apply

            <icon
            id="ico"
            name ="check">
            </icon>  
        
        </b-button>

      </div>
     </transition>
    
      <transition name="flip" mode="out-in"> 

        <div v-if="applied">
          <h2 class="h2s">Application for {{det.title}}</h2>

          <div class="group_input_title">

            <h3 class="h3s">
              Insert description.
            </h3>
            
            <textarea  
            :placeholder="descinput.label"
            :class="{'has-error':errDesc}"
            :type="descinput.type"
            :id="descinput.id" 
            v-model="descinput.value" 
            required:true
              v-validate="{
              rules:{
                  required:true
              }}"
            :name="descinput.id">
            
            </textarea>


            <span v-if="errors.has(descinput.id)" class="incorrect_input">
                {{descinput.id_upper}} required!
            </span>
          
          </div>
          <div class="group_input_title">

            <h3 class="h3s">
              Insert price.
            </h3>
          
            <div  class="fform_input">
              <input  
              :placeholder="priceinput.label"
              :class="{'has-error':errPrice}"
              :type="priceinput.type" 
              :id="priceinput.id" 
              v-model="priceinput.value" 
              required="true"
              v-validate="{rules:{
                required:true
              }}"
              :name="priceinput.id"/>
              
              <span v-if="errors.has(priceinput.id)" class="incorrect_input">
                  Price required!
              </span>
              
            </div >
          </div>

            <div class="group_input_title">

              <h3 class="h3s">
                Insert deadline for project.
              </h3>

              <!-- privremeni -->
              <div  class="fform_input">
              <input  
              :placeholder="deadlineinput.label"
              :class="{'has-error':errPrice}"
              :type="deadlineinput.type" 
              :id="deadlineinput.id" 
              v-model="deadlineinput.value" 
              required="true"
              v-validate="{rules:{
                required:true
              }}"
              :name="deadlineinput.id"/>

                <span v-if="errors.has(deadlineinput.id)" class="incorrect_input">
                    Deadline required!
                </span>
                
              </div >
          
              <!-- <div  class="fform_input">
                <input
                name="deadline"
                required:true
                :class="{'has-error':errDateDeadline}"
                />

                <span v-if="errors.has(priceinput.id)" class="incorrect_input">
                    Deadline required!
                </span>
              </div > -->

            </div>


            <b-button  
            class="btn btn-success btn-secondary send_info" 
            @click="sendInfo()">

              Send

              <icon
              id="ico"
              name ="check">
              </icon>  
        
            </b-button>
        </div>
      </transition>

  </div>

</template>

<script>
import eventBus from "../../../../utils/eventBus";
import Icon from "vue-awesome/components/Icon";
import "vue-awesome/icons/window-close";
import "vue-awesome/icons/check";
import daterangepicker from "daterangepicker";

export default {
  components: {
    Icon
  },
  destroyed() {
    let dp = $(".daterangepicker");
    let arr_of_dps = [...dp];

    arr_of_dps.forEach(l => {
      l.remove();
    });
  },
  mixins: [],
  props: {
    det: {
      type: Object,
      twoWay: true
    }
  },
  computed: {
    errDateDeadline() {
      return this.errors.has("deadline");
    },
    errPrice() {
      return this.errors.has(this.priceinput.id);
    },
    errDesc() {
      return this.errors.has(this.descinput.id);
    }
  },
  methods: {
    applyForJob() {
      this.applied = true;
    },
    sendInfo() {
      console.log(this.det);
      this.$validator.validateAll().then(form_ok => {
        if (form_ok) {
          axios
            .post("/postbid", {
              id: this.det.id,
              title: this.det.title,
              maximum_price: this.det.maximum_price,
              domain: this.det.domain,
              description: this.det.description,
              bid_price: this.priceinput.value,
              bid_deadline: this.deadlineinput.value,
              bid_desc: this.descinput.value
              // user: "hardcode"
              // desc: this.descinput.value,
              // price: this.priceinput.value,
              // det
            })
            .then(function(response) {
              console.log(response);
            })
            .catch(function(error) {
              vm.errorToast("An error happened.", "Error!");
            });
        }
      });
    },
    disableMoreInfo() {
      eventBus.$emit("isVisibleMoreInfo", false);
    }
  },
  mounted() {
    $('input[name="deadline"').daterangepicker(
      {
        singleDatePicker: true,
        showDropdowns: true,
        locale: {
          format: "DD-MMM-YYYY",
          fromLabel: "From",
          toLabel: "To",
          customRangeLabel: "Custom",
          weekLabel: "W",
          daysOfWeek: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
          monthNames: [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
          ],
          firstDay: 1
        },
        linkedCalendars: false,
        showCustomRangeLabel: false,
        alwaysShowCalendars: true,
        opens: "center"
      },
      start => {
        this.date_deadline = moment(start).format("DD/MM/YYYY");
      }
    );
  },
  data() {
    return {
      date_deadline: null,
      applied: false,
      descinput: {
        id: "desc",
        label: "description",
        type: "text",
        value: "",
        id_upper: "Description"
      },
      priceinput: {
        id: "price",
        label: "price",
        type: "number",
        value: ""
      },
      deadlineinput: {
        id: "deadline",
        label: "deadline",
        type: "text",
        value: ""
      }
    };
  }
};
</script>

<style scoped>
.send_info {
  margin-top: 4%;
}
#ico {
  vertical-align: middle;
}
#close_btn {
  float: right;
}

.has-error {
  border: 1px solid rgba(255, 0, 0, 1);
}

textarea {
  box-shadow: 0px 0px 2px #949494;
  text-align: center;
  outline: none !important;
  border-bottom: 1px solid rgba(0, 8, 53, 0.603);
  background-color: transparent;
  border: 0px;
  width: 100%;
  min-height: 80px;
}
</style>
