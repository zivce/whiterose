<template>
    <div class="comp_container">
        <h2 class="h2s" >Skills test</h2>
 
        <count-down-timer 
        ref = "countdown"
        v-if ="!test_time_expired"
        :deadline="five_minutes_deadline"
        >
        </count-down-timer>

        <test-question
        v-if ="!test_time_expired"
        v-for = "question in questions"
        :key = "question.id"
        :question.sync="question"
        >

        </test-question>
        
        <div class="d-flex flex-column">
            
          <b-button
          v-if ="!test_time_expired"
          
          style="
          width: 50%;
          margin: auto;"
          
          class="btn btn-info btn-secondary actionbtn" @click="submitHandler()">
              Submit 
          </b-button>
        
        </div>
        
        <p 
        v-if ="test_time_expired && !results_came_in"
        >
        Time expired. Wait for results.
        </p>

        <div 
        v-if="results_came_in"
        class="comp_container"
        >
            <!-- TODO: izbaci hardkod -->
            <h2 class="h2s">Results</h2>

            <p>You have answered on: <span><code>{{score.answered}}</code> questions</span></p>
            
            <p>Number of correct answer: <span><code>{{score.correct}}</code></span></p>
            
            <p>Final score: <span><code>{{score.score}}</code></span></p>

            <!-- Ovde treba ako ima iznad 60% da  -->
            <!-- <p>Your rating is : <span><code>33%</code></span></p> -->
        </div>

    </div>
</template>

<script>
import SkillsTestAPI from "../../../services/api/pentester_api/SkillsTest.api";
import TestQuestion from "./Question.vue";
import CountDownTimer from "./CountdownTimer.vue";
import eventBus from "../../../utils/eventBus";

// TODO: izbaci testove
// TODO: dodaj pitanja
// TODO: dodaj api za odgovore.

export default {
  components: {
    TestQuestion,
    CountDownTimer
  },
  created() {
    SkillsTestAPI.getSkillsTest().then(resp => {
        console.log(resp);
        this.questions = resp;
    });

    //BUG WAS HEREEE
    //hh vs HH is diff...

    this.five_minutes_deadline = moment()
      .add(5, "minutes")
      .format("YYYY-MM-DD HH:mm:ss");

    this.five_minutes_deadline = new String(this.five_minutes_deadline);

    

    eventBus.$on("time_expired", res => {
      this.test_time_expired = res;

      var answers = this.questions.map(question => {
          return{
            "id":question.id,
            "answer":question.selected ? question.selected : null
          }
      });

      SkillsTestAPI.checkAnswers(answers).then(resp => {
            this.results = resp;
      });

      //TEST:
      window.setTimeout(() => {
        this.results_came_in = true;
      }, 1000);
    });

    // this.skills = this.quest_selected;
  },
  watch: {},
  methods: {
    submitHandler() {
      var results = this.questions.map(question => {
          return{
            "id":question.id,
            "answer":question.selected ? question.selected : null
          }
      });
      this.test_time_expired = true;
      
      // SkillsTestAPI.checkAnswers(results);

      //TEST:
      window.setTimeout(() => {
        this.results_came_in = true;
      }, 1000);

      SkillsTestAPI.checkAnswers(results).then((response)=>{
        this.results_came_in = true;
        this.score = response;
      });
    }
  },
  data() {
    return {
      questions: [],
      quest_selected: null,
      five_minutes_deadline: null,
      test_time_expired: false,
      results_came_in: false
    };
  }
};
</script>

<style scoped>
</style>
